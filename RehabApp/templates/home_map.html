{% extends "base.html" %}
{% block content %}

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand">Rehab4Rehab</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <br><br>

    <div class="container">

      <style>
        .counties {
          fill: none;
        }
      
        .states {
          fill: none;
          stroke: #fff;
          stroke-linejoin: round;
        }
      </style>
      
      <div class="container">
        <svg width="960" height="600"></svg>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <script src="https://d3js.org/topojson.v2.min.js"></script>
        <!--<script src="static/js/map.js"></script>-->

        <script>
          var svg = d3.select("svg"),
              margin = {right: 10, left: 10},
              width = +svg.attr("width"),
              height = +svg.attr("height");

          var county_data = d3.map();

          var path = d3.geoPath();

          var x = d3.scaleLinear()
              .domain([-20, 20])
              .rangeRound([600, 860]);
              
          var color = d3.scaleThreshold()
              .domain(d3.range(-18, 22, 4))
              .range(d3.schemeRdBu[11].reverse());

          var g = svg.append("g")
              .attr("class", "key")
              .attr("transform", "translate(0,40)");

          g.selectAll("rect")
            .data(color.range().map(function(d) {
                d = color.invertExtent(d);
                if (d[0] == null) d[0] = x.domain()[0];
                if (d[1] == null) d[1] = x.domain()[1];
                return d;
              }))
            .enter().append("rect")
              .attr("height", 8)
              .attr("x", function(d) { return x(d[0]); })
              .attr("width", function(d) { return x(d[1]) - x(d[0]); })
              .attr("fill", function(d) { return color(d[0]); });

          g.append("text")
              .attr("class", "caption")
              .attr("x", x.range()[0])
              .attr("y", -6)
              .attr("fill", "#000")
              .attr("text-anchor", "start")
              .attr("font-weight", "bold")
              .text("Difference between measured and predicted drug poison mortality rates");

          g.call(d3.axisBottom(x)
              .tickSize(13)
              .tickFormat(function(x, i) { return i ? x : x; })
              .tickValues(color.domain()))
            .select(".domain")
              .remove();

          function make_graph () {
              d3.queue()
                .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                .defer(d3.csv, "static/rehab.csv", function(d) {
                    county_data.set(d.fips,
                      d3.map ()
                        .set("county", d.county)
                        .set("state", d.st)
                        .set("diff", +d.pred_diff))
                    })
                  .await(ready);
              function ready(error, us) {
                  if (error) throw error;

                  svg.append("g")
                    .attr("class", "counties")
                    .selectAll("path")
                    .data(topojson.feature(us, us.objects.counties).features)
                    .enter().append("path")
                    .attr("fill", function(d) { 
                        if (typeof (county_data.get(d.id)) == "undefined" ||
                            county_data.get(d.id).get("diff") == "-20") return "#ffffff";
                        else return color(d.pred_diff =
                          county_data.get(d.id).get("diff")); })
                    .attr("d", path)
                    .append("title")
                    .text(function(d) { 
                              if (typeof (county_data.get(d.id)) != "undefined")
                                return county_data.get(d.id).get("county") + ", " +
                                  county_data.get(d.id).get("state") + "\n" +
                                  "True - Predicted: " + d.pred_diff;
                              else return "";})
                              
                  svg.append("path")
                    .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                    .attr("class", "states")
                    .attr("d", path);
              };
          }
          make_graph ();
        </script>
      </div>

      <div class="starter-template">
        <h2>Choose a county:</h2>
        <form action="/home" method="GET">
          <div class="form-group">
            <label for="countyst">County: </label>
            <select name="countyst" id="countyst" type="text" onchange="this.form.submit()">
              <option value="#">--------------------</option>
              {% for entry in menu_entries %}
              <option value="{{ entry }}">{{ entry }}</option>
              {% endfor %}
            </select>
            <p>Type a state abbreviation to quickly find the counties in that state.</p>
          </div>
        </form>
        <p>OR</p>
        <p>Enter county statistics:</p>
      </div>
      <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
      <script src="../static/js/bootstrap.min.js"></script>

    </div> <!-- /.container-->
      <div class = "container">

        <form action="/home" method="GET">
          <div class="form-group">
            <label for="population">Population:</label>
            <input type="text" id="population" name='population' placeholder="e.g. 50000">
            <br>
            <label for="n_facility">Number of Rehab Facilities:</label>
            <input type="text" id="n_facility" name='n_facility' placeholder="e.g. 10">
            <br>
            <label for="opioidclaim">Opioid Claims:</label>
            <input type="text" id="opioidclaim" name='opioidclaim' placeholder="e.g. 50000">
            <br>
            <label for="opioid_rate">Opioid Prescribing Rate:</label>
            <input type="text" id="opioid_rate" name='opioid_rate' placeholder="e.g. 5 (percent)">
            <br>
            <label for="prescribers">Number of Part D Prescribers:</label>
            <input type="text" id="prescribers" name='prescribers' placeholder="e.g. 200">
            <br>
            <label for="mortality">Drug Poison Mortality Rate:</label>
            <input type="text" id="mortality" name='mortality' placeholder="e.g. 3">
            <br>
          </div>
          <div>
            <button type="submit" class="btn btn-default btn-lg">Model the county</button>
          </div>
        </form>
      </div>
      <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
      <script src="../static/js/bootstrap.min.js"></script>

    </div> <!-- /.container-->

    {% if filled %}
    <div class="container">
      <div class="starter-template">
        {% if county %}
        <h2>{{ county }}, {{ state }}:</h2>
        {% else %}
        <h2>Results:</h2>
        {% endif %}
        <p class="lead">
          The actual drug poison mortality rate is {{ paramdict['True y'] }}.<br>
          The predicted rate is {{ paramdict['Pred y'] }}.<br>
          {{ rec }}<br>
          Other statistics:<br>
          Population: {{ paramdict['Population'] }}<br>
          Number of rehab facilities: {{ paramdict['n_facilities'] }}<br>
          Number of opioid claims: {{ paramdict['Opioid Claims'] }}<br>
          Percent of all claims relating to opioids: {{ paramdict['Opioid Prescribing Rate'] }}<br>
          Number of Medicare Part D Prescribers: {{ paramdict['Part D Prescribers'] }}<br>
      </div>
      {% endif %}

    </div><!-- /.container -->

{% endblock %}